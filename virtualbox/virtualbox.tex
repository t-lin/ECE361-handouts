\documentclass[11pt]{article}

\usepackage{../style/ece361}

%-------------------------------------------------------------------------------------------------

% Lab parameters
%\def\thelab{0}
%\def\datedue{Dec. 31, 1969 @ 7 PM}

\useCompactTitle{ECE361}{VirtualBox Setup Guide}

%-------------------------------------------------------------------------------------------------
\begin{document}
% Create title page, and force header and footer onto it
\maketitle \thispagestyle{fancy}

%\hfill {\large \textbf{Due \datedue}}
%-------------------------------------------------------------------------------------------------


%-------------------------------------------------------------------------------------------------
\section{Overview}
\label{sec:overview}
%-------------------------------------------------------------------------------------------------
The labs in this course will be conducted using a Linux-based virtual machine (VM) that we will provide you. A VM is a computer that is emulated using software. This allows users to run any computer system over another underlying computer system (e.g. you can run a Windows VM in an underlying Linux computer). To run VMs, you will need a hypervisor, a software that enables multiple VMs to coexist on the same computer.

In this course, you will use VirtualBox~\footnote{VirtualBox: https://www.virtualbox.org/} as the hypervisor. VirtualBox is free and available for Windows, macOS, and Linux. The purpose of this setup guide is to walk you through how to install VirtualBox on your computer, and how to setup the course VM.


%-------------------------------------------------------------------------------------------------
\section{Download and Installation}
\label{sec:download}
%-------------------------------------------------------------------------------------------------
Download and save the appropriate installation package for your platform. To download VirtualBox, please visit: \url{https://www.virtualbox.org/wiki/Downloads}

This section will walk you through the installation process. Please go to section~\ref{subsec:install-windows} if you use Windows, or section~\ref{subsec:install-osx} if you use macOS.

%-------------------------------------------------------------------------------------------------
\subsection{Installation (Windows)}
\label{subsec:install-windows}
%-------------------------------------------------------------------------------------------------
This section will walk you through an installation of VirtualBox version \textbf{6.1.0} on \textbf{Windows 10}. Other versions of VirtualBox should have a similar process, though the following figures below may not exactly match.

\textbf{Step 1:} Locate the *.exe installation package that you downloaded and run it. You should see something similar to the Fig.~\ref{install-1}. Click on \texttt{Next} to proceed.
% figvs takes 4 parameters (see the style sheet for source code)
%   1) Image width (w.r.t. column)
%   2) Image file name and label
%   3) Other 'includegraphics' parameters
%   4) Caption
\figvs{0.6}{install-1}{trim=0cm 0cm 0cm 0cm,clip}{Launching the VirtualBox Setup Wizard.}

\textbf{Step 2:} In the custom setup options, Fig.~\ref{install-2}, keep the default settings (i.e. install everything). Click on \texttt{Next} to proceed.
\figvs{0.6}{install-2}{trim=0cm 0cm 0cm 0cm,clip}{VirtualBox custom setup options.}

\textbf{Step 3:} Of the various options shown in Fig.~\ref{install-3}, you should register the file associations such that VirtualBox can recognize VM-related file extensions. If you prefer not to create shortcuts and start menu entries, you may skip the first three items.
\figvs{0.6}{install-3}{trim=0cm 0cm 0cm 0cm,clip}{VirtualBox shortcuts and file associations.}

\textbf{Step 4:} In order for your VM to have access to the Internet (which is required for this course), you need to install the VirtualBox networking features. Click on \texttt{Yes} in the dialog shown in Fig.~\ref{install-4}.

\warn{This step may temporarily reset your network connection. If you're in the middle of an important connection (e.g. file download, video conferencing, etc.), wait until you're finished before proceeding with the installation}
\figvs{0.6}{install-4}{trim=0cm 0cm 0cm 0cm,clip}{VirtualBox networking interfaces must be installed.}

\textbf{Step 5:} Now you're ready to proceed with the installation. Click on \texttt{Install}.
\figvs{0.6}{install-5}{trim=0cm 0cm 0cm 0cm,clip}{Confirm to begin installation.}

\textbf{Step 6:} The installation process may prompt you to install the Oracle Corporation Universal Serial Bus (USB) package, as seen in Fig.~\ref{install-6}. This enables your VM to connect to USB devices on your physical computer. This is highly recommended as you may occasionally wish to connect a USB device to your VM (e.g. a flash drive if the networking fails, or a mouse). Click on \texttt{Install} to proceed.
\figvs{0.6}{install-6}{trim=0cm 0cm 0cm 0cm,clip}{Confirm installation of the Oracle Universal Serial Bus package.}

\textbf{Step 7:} When the installation has finished, click \texttt{Finish} to complete the process and launch VirtualBox. You should see the VirtualBox Manager, similar to that shown in Fig.~\ref{vbox-manager}.
\figvs{0.8}{vbox-manager}{trim=0cm 0cm 0cm 0cm,clip}{VirtualBox Manager interface.}

Proceed to section~\ref{sec:setup-run-vm} to download, setup, and run the course VM.


\subsection{Installation (macOS)}
\label{subsec:install-osx}
This section will walk you through an installation of VirtualBox version \textbf{6.1.0} on \textbf{macOS Catalina}. Other versions should have a similar process, though the following figures below may not exactly match.

\textbf{Step 1:} Locate the *.dmg installation package that you downloaded and run it. You should see something similar to the Fig.~\ref{mac-install-1}. Click on \texttt{Continue} to proceed.
\figvs{0.6}{mac-install-1}{trim=0cm 0cm 0cm 0cm,clip}{VirtualBox Manager interface.}

\textbf{Step 2:} Click \texttt{Install} on the next screen. The installer may prompt you to enter your computer's user name and password, as seen in Fig.~\ref{mac-install-2}; please do so, as this is perfectly safe.
\figvs{0.6}{mac-install-2}{trim=0cm 0cm 0cm 0cm,clip}{VirtualBox Manager interface.}

If the installation fails with the message shown in Fig.~\ref{mac-install-2a}, then you will have to modify the Security \& Privacy settings on your computer.
\figvs{0.6}{mac-install-2a}{trim=0cm 0cm 0cm 0cm,clip}{VirtualBox Manager interface.}

Go to your computer's Security \& Privacy settings. Click the lock button at the bottom-left corner and enter your password. Click on \texttt{Allow}, as seen in Fig.~\ref{mac-install-2b}. Afterwards, you'll have to re-run the installation package.
\figvs{0.6}{mac-install-2b}{trim=0cm 0cm 0cm 0cm,clip}{VirtualBox Manager interface.}

\textbf{Step 3:} If all goes well and the installation process is finished, launch VirtualBox. You should see something similar to Fig.~\ref{vbox-manager}.

You're now ready to download, setup, and run the course VM.

%-------------------------------------------------------------------------------------------------
\section{Setup and Running the Course VM}
\label{sec:setup-run-vm}
%-------------------------------------------------------------------------------------------------
Now that you have VirtualBox installed, you can setup and run VMs on your computer. 

%-------------------------------------------------------------------------------------------------
\subsection{Setup the Course VM with VirtualBox}
\label{subsec:setup-vm}
%-------------------------------------------------------------------------------------------------
In this section, you will download and and setup the course VM.

\textbf{Step 1:} Download the course VM image from:\\
\url{https://drive.google.com/open?id=1Q2jUz-9mt8VMhA0pQKRe79fbcGT-MII-}

\noindent Once you've downloaded it, un-tar it to extract the \texttt{ece361.vdi} file within. The *.vdi extension format indicates this is a Virtual Disk Image.

\textbf{Step 2:} Start VirtualBox. In the VirtualBox Manager, click on \texttt{New} as highlighted in Fig.~\ref{vm-1}.
\figvs{0.6}{vm-1}{trim=0cm 0cm 0cm 0cm,clip}{Create a new VM in the VirtualBox Manager.}

\textbf{Step 3:} Click on \texttt{Expert Mode}, highlighted in Fig.~\ref{vm-2}, to see more configuration options.
\figvs{0.6}{vm-2}{trim=0cm 0cm 0cm 0cm,clip}{Enabled Expert Mode.}

\textbf{Step 4:} Provide your VM with a name (e.g. \texttt{ece361}). Specify \texttt{Linux} as the type, using \texttt{Ubuntu (64-bit)} as the version. For the memory size, 2048 MB (2 GB) is the minimum recommended amount to allocate to your VM.
\point{If you only see 32-bit options, please see the Troubleshooting (section~\ref{sec:troubleshooting}) below.}
\figvs{0.6}{vm-3}{trim=0cm 0cm 0cm 0cm,clip}{VM configuration options.}

\textbf{Step 5:} Select \texttt{Use an existing virtual hard disk file} and click on the small folder icon in the bottom right, as shown in Fig.~\ref{vm-4}. This will open up the Hard Disk Selector.
\figvs{0.6}{vm-4}{trim=0cm 0cm 0cm 0cm,clip}{Specify that you will use an existing virtual hard disk.}

\textbf{Step 6:} In the Hard Disk Selector, click on \texttt{Add} as shown in Fig.~\ref{vm-5}. Browse to where you extracted \texttt{ece361.vdi}, and select it, then confirm by clicking on \texttt{Choose}.
\figvs{0.6}{vm-5}{trim=0cm 0cm 0cm 0cm,clip}{VirtualBox Hard Disk Selector.}

\textbf{Step 7:} Finally, click on \texttt{Create} to create the VM. Note that this does not run the VM yet.
\figvs{0.6}{vm-6}{trim=0cm 0cm 0cm 0cm,clip}{Create the VM.}

\textbf{Step 8:} Before you run the VM, modify the VM's settings to allocate more CPUs to it. Click on \texttt{Settings} as shown in Fig.~\ref{vm-7}.
\figvs{0.6}{vm-7}{trim=0cm 0cm 0cm 0cm,clip}{Modifying the VM's settings.}

Select \texttt{System} on the left, followed by \texttt{Processor} on the right (see Fig~\ref{vm-8}, and adjust the number of CPUs allocated. A minimum of 2 is required, but more is better (e.g. 4 would be optimal). Press \texttt{OK} when finished.
\figvs{0.6}{vm-8}{trim=0cm 0cm 0cm 0cm,clip}{Adjusting the VM's allocation of CPUs.}

%-------------------------------------------------------------------------------------------------
\subsection{Running the Course VM}
\label{subsec:run-vm}
%-------------------------------------------------------------------------------------------------
Now that you've created a VM with VirtualBox using the disk image provided, you can start the VM. In the VirtualBox Manager, click the \texttt{Start} button with the green arrow, as shown in Fig.~\ref{vm-start-1}.
\figvs{0.6}{vm-start-1}{trim=0cm 0cm 0cm 0cm,clip}{Start the virtual machine.}

After a while, you should see the graphical login page, Fig~\ref{vm-start-2}. You can log into the default account, named \textbf{\texttt{ubuntu}}, using the password \textbf{\texttt{ece361}}.
\figvs{0.6}{vm-start-2}{trim=0cm 0cm 0cm 0cm,clip}{Login page of the course VM.}

Once logged in, you should see the desktop, similar to Fig.~\ref{vm-start-3}. If this is the first time running the VM, update it now!
\work{Update the VM: Open a terminal (in the VM), and type \texttt{ece361-update}}
\figvs{0.6}{vm-start-3}{trim=0cm 0cm 0cm 0cm,clip}{Desktop of the course VM.}


\newpage
%-------------------------------------------------------------------------------------------------
\section{Troubleshooting}
\label{sec:troubleshooting}
%-------------------------------------------------------------------------------------------------
This section provides troubleshooting for common issues. If you're facing a problem that is not listed here, please make a post on Piazza, or bring your laptop to the lab. Common problems and their solutions will be added here in the future.

%-------------------------------------------------------------------------------------------------
\subsection{VM's Screen Size Too Small or Cannot Scale}
%-------------------------------------------------------------------------------------------------
You will need to first install the VirtualBox Guest Additions \textit{into the VM itself}, then adjust the VM's monitor settings.

\textbf{Step 1:} Insert VirtualBox's Guest Additions CD image into the VM, as seen in Fig.~\ref{tshoot-guest-ext-1}. When it asks to open it in the File Manager, click \texttt{OK}.
\figvs{0.6}{tshoot-guest-ext-1}{trim=0cm 0cm 0cm 0cm,clip}{Insert the GuestAdditions CD image.}

\textbf{Step 2:} Double-click on \texttt{autorun.sh}. In the resulting options, select \texttt{Execute}. This process may take up to a minute before it finishes.
\figvs{0.6}{tshoot-guest-ext-2}{trim=0cm 0cm 0cm 0cm,clip}{Execute the installation process.}

\textbf{Step 3:} Reboot the VM.

\textbf{Step 4:} Once the VM has been rebooted and you've logged back in, select \texttt{Scaled Mode}, as seen in Fig~\ref{tshoot-scale-1}. 
\figvs{0.6}{tshoot-scale-1}{trim=0cm 0cm 0cm 0cm,clip}{Enable Scaled Mode.}

\textbf{Step 5:} Find the VM's monitor settings, and adjust the resolution as you see fit.
\figvs{0.6}{tshoot-scale-2}{trim=0cm 0cm 0cm 0cm,clip}{Adjust the Monitor Settings.}


%-------------------------------------------------------------------------------------------------
\subsection{VERR\_NEM\_VM\_CREATE\_FAILED Error}
%-------------------------------------------------------------------------------------------------
If you see an error similar to Fig.~\ref{tshoot-verr-nem-vm} in Windows 10, then you may need to disable a few services. VirtualBox currently does not work well alongside other virtualization technologies and features used by Windows.
\figvs{0.4}{tshoot-verr-nem-vm}{trim=0cm 0cm 0cm 0cm,clip}{VERR\_NEM\_VM\_CREATE\_FAILED Error}

In the Windows start menu, search for \texttt{Turn Windows features on or off}. You can then enable/disable features, some of which may require you to restart your computer. Features known to interfere with VirtualBox \textbf{6.1.0} include: \texttt{Hyper-V}, \texttt{Virtual Machine Platform}, and \texttt{Windows Hypervisor Platform}.

Please see \url{https://forums.virtualbox.org/viewtopic.php?p=450399#p450399} for a list of Windows feature you \textit{may} need to disable (you may not have all of them).

\warn{If you use Windows Subsystem for Linux 2 (WSL 2), you may need to revert your Linux distribution back to WSL 1, since WSL 2 depends on \texttt{Virtual Machine Platform} which must be disabled. To check if your Linux distributions are using WSL 1 or 2, open a Windows command prompt, and type \texttt{wsl -l -v}. If any of them are using 2, you can revert them back to 1 by typing \texttt{wsl --set-version <Distro> 1}. This process may take a while for each distribution.}

%-------------------------------------------------------------------------------------------------
\subsection{Only 32-bit VM Versions Available}
%-------------------------------------------------------------------------------------------------
Possible causes of this issue include:
\begin{itemize}
    \item \textbf{Your CPU's virtualization feature is disabled.} To enable, you must go into your computer's BIOS (this varies across computers) and enable virtualization. For Intel CPUs, the feature is called \texttt{Intel Virtualization (VT-x)} and it must be enabled, as well as \texttt{VT-d} if it exists. For AMD CPUs, the feature is called \texttt{AMD Virtualization (AMD-V)}.
    \item \textbf{Windows 10's Memory Integrity feature is on.} This is a relatively new security feature in Windows to protect the kernel's memory. However, it uses Windows virtualization features to do so, which currently does not work well with VirtualBox. In the Windows start menu, search for \texttt{Core Isolation}. If \texttt{Memory Integrity} is on, turn it off.
\end{itemize}

\end{document}
